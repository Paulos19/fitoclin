generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS (Tipos fixos) ---

enum Role {
  ADMIN // Dra. Isa
  PATIENT // Pacientes
}

enum AppointmentStatus {
  SCHEDULED // Agendado
  COMPLETED // Realizado
  CANCELED // Cancelado
  MISSED // Faltou
}

enum ConsultationType {
  FIRST_VISIT // Primeira Consulta
  FOLLOW_UP // Retorno
  EMERGENCY // Urg√™ncia
}

// --- MODELOS PRINCIPAIS ---

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String // Ser√° hash
  role      Role     @default(PATIENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  image   String? // Foto de perfil
  patient Patient? // Se for paciente, ter√° esse perfil

  // Auditoria (Quem criou o registro, etc)
  appointments         Appointment[]
  doctorSchedules      DoctorSchedule[]
  notifications        Notification[]
  userLessonProgresses UserLessonProgress[]
}

model Patient {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Dados Pessoais
  phone      String?
  birthDate  DateTime?
  gender     String?
  occupation String?

  // Endere√ßo
  address String?
  city    String?
  state   String?

  // Hist√≥rico
  bio String? // Resumo cl√≠nico inicial

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos do Sistema
  medicalRecords MedicalRecord[] // Prontu√°rio
  prescriptions  Prescription[] // Receitas
  appointments   Appointment[] // Consultas
  exams          Exam[] // Exames Anexados
  transactions   Transaction[]
  anamnesis      Anamnesis?
  weeklyCheckins WeeklyCheckin[]
  documents      Document[]
}

// --- PRONTU√ÅRIO ELETR√îNICO (PEP) ---

model MedicalRecord {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  date  DateTime @default(now())
  title String // Ex: "Consulta de Retorno - 3 Meses"

  // 5 PILARES DO M√âTODO FITOCLIN (Armazenado como texto ou JSON estruturado)
  pilar1_investigacao String? // Investiga√ß√£o Profunda
  pilar2_fitoterapia  String? // Fitoterapia Personalizada
  pilar3_metabolismo  String? // Modula√ß√£o Metab√≥lica
  pilar4_estresse     String? // Gest√£o do Estresse
  pilar5_evolucao     String? // Evolu√ß√£o

  notes String? // Anota√ß√µes gerais livres

  createdAt DateTime @default(now())
}

// --- PRESCRI√á√ÉO FITOTER√ÅPICA ---

model Prescription {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  title   String // Ex: "Protocolo Desinflama√ß√£o"
  content String // Conte√∫do completo (HTML ou JSON da receita)
  pdfUrl  String? // Link se gerou PDF

  validUntil DateTime?
  createdAt  DateTime  @default(now())
}

// --- AGENDA & CONSULTAS ---

model Notification {
  id     String @id @default(cuid())
  userId String // Quem vai receber (no caso, a Dra/Admin)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title   String
  message String
  read    Boolean @default(false) // Para marcar como lida depois
  link    String? // Opcional: Link para clicar e ir direto (ex: ver o agendamento)

  createdAt DateTime @default(now())
}

model Appointment {
  id String @id @default(cuid())

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  doctorId String
  doctor   User   @relation(fields: [doctorId], references: [id])

  date     DateTime
  duration Int      @default(60)

  status AppointmentStatus @default(SCHEDULED)
  type   ConsultationType  @default(FIRST_VISIT)

  meetLink String?
  notes    String?

  createdAt DateTime @default(now())

  // üëá TRAVA DE SEGURAN√áA:
  // Impede 2 agendamentos para o mesmo m√©dico no mesmo hor√°rio exato.
  @@unique([doctorId, date])
}

model DoctorSchedule {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  dayOfWeek Int // 0 = Domingo, 1 = Segunda... 6 = S√°bado
  startTime String // Ex: "09:00"
  endTime   String // Ex: "18:00"

  isEnabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, dayOfWeek]) // S√≥ pode ter uma regra por dia da semana
}

// --- EXAMES & ARQUIVOS ---

model Exam {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  title    String
  fileUrl  String // URL do upload (Blob/S3)
  fileType String // pdf, jpg, etc

  uploadedAt DateTime @default(now())
}

model Plan {
  id         String  @id @default(cuid())
  name       String // Ex: "Plano Mensal"
  price      Decimal @default(0.00) @db.Decimal(10, 2)
  period     String // Ex: "/m√™s"
  features   String // Lista de benef√≠cios separados por ponto-e-v√≠rgula (;)
  highlight  Boolean @default(false) // Se √© o plano destaque
  buttonText String  @default("Assinar Agora")
  buttonLink String?

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SiteInfo {
  id  String @id @default(cuid())
  // Identificador √∫nico para garantir que s√≥ tenhamos 1 registro de config
  key String @unique @default("homepage_config")

  heroTitle    String?
  heroSubtitle String?
  aboutText    String?
  whatsapp     String?
  instagram    String?

  updatedAt DateTime @updatedAt
}

model Transaction {
  id          String          @id @default(cuid())
  description String // Ex: "Consulta Maria", "Conta de Luz", "Venda Curso"
  amount      Decimal         @db.Decimal(10, 2) // Valor exato
  type        TransactionType // INCOME (Entrada) ou EXPENSE (Sa√≠da)
  category    String // Ex: "Consultas", "Marketing", "Infraestrutura"

  status PaymentStatus @default(PAID) // Padr√£o como pago para agilizar
  date   DateTime      @default(now()) // Data da transa√ß√£o

  // Opcional: Vincular a um paciente (para saber quem pagou)
  patientId String?
  patient   Patient? @relation(fields: [patientId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Lead {
  id     String  @id @default(cuid())
  name   String
  phone  String
  email  String?
  source String // Ex: "Instagram", "Indica√ß√£o", "Google"

  status LeadStatus @default(NEW)
  notes  String? // Ex: "Quer emagrecer, prefere tarde"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Anamnesis {
  id String @id @default(cuid())

  // V√≠nculo
  patientId String  @unique
  patient   Patient @relation(fields: [patientId], references: [id])

  // --- PARTE 1: INFORMA√á√ïES B√ÅSICAS ---
  fullName          String
  age               String
  profession        String
  phone             String
  consultationDate  DateTime? // Data informada pelo paciente
  isFirstTime       Boolean // J√° passou antes?
  diagnosedDiseases String?   @db.Text
  mainComplaint     String    @db.Text // Principal inc√¥modo

  // --- PARTE 2: ESCALAS (0 a 10) ---
  // F√≠sica
  sleepQuality  Int // 0-10
  bowelFunction Int // Intestino
  energyLevel   Int
  bodyPain      Int
  immunity      Int

  // Emocional
  anxiety          Int
  sadness          Int
  mentalClarity    Int
  stressHandling   Int
  lifeSatisfaction Int
  purpose          Int

  // Espiritual
  spirituality Int
  selfCare     Int
  innerPeace   Int

  // --- PARTE 3: H√ÅBITOS ---
  medications String? @db.Text
  supplements String? @db.Text // Ch√°s, fito
  allergies   String? @db.Text
  dietQuality Int // 0-10 (Como avalia alimenta√ß√£o)

  // --- LGPD ---
  lgpdAuthorized Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WeeklyCheckin {
  id String @id @default(cuid())

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // M√©tricas principais (0-10)
  sleepQuality Int
  energyLevel  Int
  mood         Int
  digestion    Int

  notes String? @db.Text // Alguma observa√ß√£o da semana (ex: "Comi gl√∫ten")

  createdAt DateTime @default(now())

  // √çndice para facilitar ordena√ß√£o por data
  @@index([patientId, createdAt])
}

model Document {
  id    String @id @default(cuid())
  title String // Ex: "Hemograma Completo"
  url   String // Link do arquivo (Blob ou Drive)
  type  String // "EXAM", "PRESCRIPTION", "OTHER"

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  createdAt DateTime @default(now())
}

model Course {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  imageUrl    String?
  active      Boolean  @default(false)
  price       Decimal? @default(0.00) @db.Decimal(10, 2)

  modules Module[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Module {
  id    String @id @default(cuid())
  title String
  order Int    @default(0) // Para ordenar 1, 2, 3...

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  lessons Lesson[]
}

model Lesson {
  id          String  @id @default(cuid())
  title       String
  videoUrl    String? // Link do YouTube, Vimeo ou Vercel Blob
  description String? @db.Text
  duration    Int? // Em minutos (opcional)
  order       Int     @default(0)

  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  progress UserLessonProgress[]
}

model UserLessonProgress {
  id       String @id @default(cuid())
  userId   String
  lessonId String

  completed Boolean  @default(false)
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId]) // Um usu√°rio s√≥ tem um registro de progresso por aula
}

enum LeadStatus {
  NEW // Novo (Chegou agora)
  CONTACTED // J√° mandei oi
  SCHEDULED // Agendou a consulta
  WON // Virou Paciente (Sucesso!)
  LOST // Desistiu / Sem resposta
}

enum TransactionType {
  INCOME // Receita
  EXPENSE // Despesa
}

enum PaymentStatus {
  PENDING // Pendente
  PAID // Pago
  CANCELED // Cancelado
}
