generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS (Tipos fixos) ---

enum Role {
  ADMIN // Dra. Isa
  PATIENT // Pacientes
}

enum AppointmentStatus {
  SCHEDULED // Agendado
  COMPLETED // Realizado
  CANCELED // Cancelado
  MISSED // Faltou
}

enum ConsultationType {
  FIRST_VISIT // Primeira Consulta
  FOLLOW_UP // Retorno
  EMERGENCY // Urg√™ncia
}

// --- MODELOS PRINCIPAIS ---

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String // Ser√° hash
  role      Role     @default(PATIENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  image   String? // Foto de perfil
  patient Patient? // Se for paciente, ter√° esse perfil

  // Auditoria (Quem criou o registro, etc)
  appointments    Appointment[]
  doctorSchedules DoctorSchedule[]
  notifications   Notification[]
}

model Patient {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Dados Pessoais
  phone      String?
  birthDate  DateTime?
  gender     String?
  occupation String?

  // Endere√ßo
  address String?
  city    String?
  state   String?

  // Hist√≥rico
  bio String? // Resumo cl√≠nico inicial

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos do Sistema
  medicalRecords MedicalRecord[] // Prontu√°rio
  prescriptions  Prescription[] // Receitas
  appointments   Appointment[] // Consultas
  exams          Exam[] // Exames Anexados
}

// --- PRONTU√ÅRIO ELETR√îNICO (PEP) ---

model MedicalRecord {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  date  DateTime @default(now())
  title String // Ex: "Consulta de Retorno - 3 Meses"

  // 5 PILARES DO M√âTODO FITOCLIN (Armazenado como texto ou JSON estruturado)
  pilar1_investigacao String? // Investiga√ß√£o Profunda
  pilar2_fitoterapia  String? // Fitoterapia Personalizada
  pilar3_metabolismo  String? // Modula√ß√£o Metab√≥lica
  pilar4_estresse     String? // Gest√£o do Estresse
  pilar5_evolucao     String? // Evolu√ß√£o

  notes String? // Anota√ß√µes gerais livres

  createdAt DateTime @default(now())
}

// --- PRESCRI√á√ÉO FITOTER√ÅPICA ---

model Prescription {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  title   String // Ex: "Protocolo Desinflama√ß√£o"
  content String // Conte√∫do completo (HTML ou JSON da receita)
  pdfUrl  String? // Link se gerou PDF

  validUntil DateTime?
  createdAt  DateTime  @default(now())
}

// --- AGENDA & CONSULTAS ---

model Notification {
  id     String @id @default(cuid())
  userId String // Quem vai receber (no caso, a Dra/Admin)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title   String
  message String
  read    Boolean @default(false) // Para marcar como lida depois
  link    String? // Opcional: Link para clicar e ir direto (ex: ver o agendamento)

  createdAt DateTime @default(now())
}

model Appointment {
  id String @id @default(cuid())

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  doctorId String
  doctor   User   @relation(fields: [doctorId], references: [id])

  date     DateTime
  duration Int      @default(60)

  status AppointmentStatus @default(SCHEDULED)
  type   ConsultationType  @default(FIRST_VISIT)

  meetLink String?
  notes    String?

  createdAt DateTime @default(now())

  // üëá TRAVA DE SEGURAN√áA:
  // Impede 2 agendamentos para o mesmo m√©dico no mesmo hor√°rio exato.
  @@unique([doctorId, date])
}

model DoctorSchedule {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  dayOfWeek Int // 0 = Domingo, 1 = Segunda... 6 = S√°bado
  startTime String // Ex: "09:00"
  endTime   String // Ex: "18:00"

  isEnabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, dayOfWeek]) // S√≥ pode ter uma regra por dia da semana
}

// --- EXAMES & ARQUIVOS ---

model Exam {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  title    String
  fileUrl  String // URL do upload (Blob/S3)
  fileType String // pdf, jpg, etc

  uploadedAt DateTime @default(now())
}

model Course {
  id          String  @id @default(cuid())
  title       String
  description String
  price       String? // Ex: "R$ 997,00" ou "12x de R$ 99"
  imageUrl    String?
  linkUrl     String? // Link para Hotmart/Eduzz
  active      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Plan {
  id         String  @id @default(cuid())
  name       String // Ex: "Plano Mensal"
  price      String // Ex: "R$ 199"
  period     String // Ex: "/m√™s"
  features   String // Lista de benef√≠cios separados por ponto-e-v√≠rgula (;)
  highlight  Boolean @default(false) // Se √© o plano destaque
  buttonText String  @default("Assinar Agora")
  buttonLink String?

  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SiteInfo {
  id  String @id @default(cuid())
  // Identificador √∫nico para garantir que s√≥ tenhamos 1 registro de config
  key String @unique @default("homepage_config")

  heroTitle    String?
  heroSubtitle String?
  aboutText    String?
  whatsapp     String?
  instagram    String?

  updatedAt DateTime @updatedAt
}
